---
title: "Benchmarking DelayedArray branch of **minfi**"
author: "Peter Hickey"
date: "`r BiocStyle::doc_date()`"
output:
  github_document:
    toc: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

## Setup

```{r, include = FALSE, setup}
knitr::opts_chunk$set(echo = TRUE, comment = "#>", collapse = TRUE,
                      message = TRUE, warning = TRUE)
```

```{r}
suppressPackageStartupMessages(library(minfi))
suppressPackageStartupMessages(library(minfiData))
```

## Using **minfi** v1.25.1

```{r 1.25.1}
RGSet <- minfiData::RGsetEx
MSet <- minfiData::MsetEx

system.time(MSetRaw_v1.25.1 <- minfi::preprocessRaw(RGSet))
system.time(MSetSWAN_v1.25.1 <- minfi::preprocessSWAN(RGSet))
system.time(MSetIllumina_v1.25.1 <- minfi::detectionP(RGSet))
system.time(MSetNoob_v1.25.1 <- minfi::preprocessNoob(RGSet))
system.time(detP_v1.25.1 <- minfi::detectionP(RGSet))
system.time(oob_v1.25.1 <- minfi::getOOB(RGSet))

system.time(MSetQuantile_v1.25.1 <- minfi::preprocessQuantile(MSet))
system.time(MSetFixedOutliers_v1.25.1 <- minfi::fixMethOutliers(MSet))
```

## Using DelayedArray branch of **minfi**

Some setting up:

```{r}
source("setup_devel_workspace.R")
```

Create the various _RGChannelSet_ and _MethylSet_ objects:

```{r}
setRealizationBackend(NULL)
system.time(RGSet_in_memory_DelayedMatrix <- realize(RGSet))
system.time(MSet_in_memory_DelayedMatrix <- realize(MSet))

setRealizationBackend("HDF5Array")
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE * 100L)
system.time(RGSet_on_disk_DelayedMatrix <- realize(RGSet))
system.time(MSet_on_disk_DelayedMatrix <- realize(MSet))

# Reset BACKEND and block size to defaults
setRealizationBackend(NULL)
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE)
```

### Using an ordinary _matrix_-backed _RGChannelSet_

```{r}
system.time(MSetRaw <- preprocessRaw(RGSet))
system.time(MSetIllumina <- preprocessIllumina(RGSet))
system.time(MSetSWAN <- preprocessSWAN(RGSet))
system.time(MSetNoob <- preprocessNoob(RGSet))
system.time(detP <- detectionP(RGSet))
system.time(oob <- getOOB(RGSet))

system.time(MSetQuantile <- preprocessQuantile(MSet))
system.time(MSetFixedOutliers <- fixMethOutliers(MSet))
```

### Using an in-memory _DelayedMatrix_-backed _RGChannelSet_

#### Default block size

```{r}
setRealizationBackend(NULL)
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE)

system.time(
    MSetRaw_in_memory_DelayedMatrix <- preprocessRaw(
        RGSet_in_memory_DelayedMatrix))
system.time(
    MSetSWAN_in_memory_DelayedMatrix <- preprocessSWAN(
        RGSet_in_memory_DelayedMatrix))
system.time(
    MSetIllumina_in_memory_DelayedMatrix <- preprocessIllumina(
        RGSet_in_memory_DelayedMatrix))
system.time(
    MSetNoob_in_memory_DelayedMatrix <- preprocessNoob(
        RGSet_in_memory_DelayedMatrix))
system.time(
    detP_in_memory_DelayedMatrix <- detectionP(RGSet_in_memory_DelayedMatrix))
system.time(
    oob_in_memory_DelayedMatrix <- getOOB(RGSet_in_memory_DelayedMatrix))

system.time(
    MSetQuantile_in_memory_DelayedMatrix <- preprocessQuantile(
        MSet_in_memory_DelayedMatrix))
system.time(
    fixMethOutliers_in_memory_DelayedMatrix <- fixMethOutliers(
        MSet_in_memory_DelayedMatrix))
```

#### Increased block size

```{r}
setRealizationBackend(NULL)
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE * 100L)

system.time(MSetRaw_in_memory_DelayedMatrix <- preprocessRaw(
    RGSet_in_memory_DelayedMatrix))
system.time(
    MSetSWAN_in_memory_DelayedMatrix <- preprocessSWAN(
        RGSet_in_memory_DelayedMatrix))
system.time(
    MSetIllumina_in_memory_DelayedMatrix <- preprocessIllumina(
        RGSet_in_memory_DelayedMatrix))
system.time(
    MSetNoob_in_memory_DelayedMatrix <- preprocessNoob(
        RGSet_in_memory_DelayedMatrix))
system.time(
    detP_in_memory_DelayedMatrix <- detectionP(RGSet_in_memory_DelayedMatrix))
system.time(
    oob_in_memory_DelayedMatrix <- getOOB(RGSet_in_memory_DelayedMatrix))

system.time(
    MSetQuantile_in_memory_DelayedMatrix <- preprocessQuantile(
        MSet_in_memory_DelayedMatrix))
system.time(
    fixMethOutliers_in_memory_DelayedMatrix <- fixMethOutliers(
        MSet_in_memory_DelayedMatrix))
```

### Using an on-disk (HDF5) _DelayedMatrix_-backed _RGChannelSet_

Using the **HDF5Array** backend

#### Default block size

```{r}
setRealizationBackend("HDF5Array")
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE)

system.time(
    MSetRaw_on_disk_DelayedMatrix <- preprocessRaw(RGSet_on_disk_DelayedMatrix))
system.time(
    MSetSWAN_on_disk_DelayedMatrix <- preprocessSWAN(
        RGSet_on_disk_DelayedMatrix))
system.time(
    MSetIllumina_on_disk_DelayedMatrix <- preprocessIllumina(
        RGSet_on_disk_DelayedMatrix))
system.time(
    MSetNoob_on_disk_DelayedMatrix <- preprocessNoob(
        RGSet_on_disk_DelayedMatrix))
system.time(
    detP_on_disk_DelayedMatrix <- detectionP(RGSet_on_disk_DelayedMatrix))
system.time(oob_on_disk_DelayedMatrix <- getOOB(RGSet_in_memory_DelayedMatrix))

system.time(
    MSetQuantile_on_disk_DelayedMatrix <- preprocessQuantile(
        MSet_on_disk_DelayedMatrix))
system.time(
    fixMethOutliers_in_memory_DelayedMatrix <- fixMethOutliers(
        MSet_on_disk_DelayedMatrix))
```

#### Increased block size

```{r}
setRealizationBackend("HDF5Array")
options(DelayedArray.block.size = DEFAULT_BLOCK_SIZE * 100L)

system.time(
    MSetRaw_on_disk_DelayedMatrix <- preprocessRaw(RGSet_on_disk_DelayedMatrix))
system.time(
    MSetSWAN_on_disk_DelayedMatrix <- preprocessSWAN(
        RGSet_on_disk_DelayedMatrix))
system.time(
    MSetIllumina_on_disk_DelayedMatrix <- preprocessIllumina(
        RGSet_on_disk_DelayedMatrix))
system.time(
    MSetNoob_on_disk_DelayedMatrix <- preprocessNoob(
        RGSet_on_disk_DelayedMatrix))
system.time(
    detP_on_disk_DelayedMatrix <- detectionP(RGSet_on_disk_DelayedMatrix))
system.time(oob_on_disk_DelayedMatrix <- getOOB(RGSet_in_memory_DelayedMatrix))

system.time(
    MSetQuantile_on_disk_DelayedMatrix <- preprocessQuantile(
        MSet_on_disk_DelayedMatrix))
system.time(fixMethOutliers_in_memory_DelayedMatrix <-
                fixMethOutliers(MSet_on_disk_DelayedMatrix))
```
